<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ar.js Test</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- we import arjs version without NFT but with marker + location based support -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="viewer__container">
          <!-- Scene for AR -->
      <a-scene>
        <!-- Assets to be used -->
        <a-assets>
          <img id="den_1" src="./tiles/1/den.jpg" />
        </a-assets>
  
        <!-- Model of the room -->
        <a-entity
          id="model"
          position="0 0 0"
          rotation="90 -180 0"
          scale="50 50 50"
          gltf-model="./models/sphere.glb"
          material="src: #den_1"
          visible="true"
        >
        </a-entity>
  
        <!-- Example hotspot, directly in front of the camera, takes person to entrance scene -->
        <!-- <a-entity
          id="hotspot"
          class="clickable"
          geometry="primitive: sphere"
          material="color: white"
          position="0 0.5 -4"
          scale="0.1 0.1 0.1"
          onclick="changeScene(`entrance.jpg`)"
        ></a-entity> -->
  
        <!-- Camera entity -->
        <a-entity
          id="camera"
          rotation="0 0 0"
          position="0 0 0"
          camera
          look-controls
        >
          <!-- Cursor for mobile mode -->
          <a-entity
            cursor="fuse: true; fuseTimeout: 500"
            objects=".clickable"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: black; shader: flat"
          >
          </a-entity>
        </a-entity>
      </a-scene>
  
      <!-- Button to change the package -->
      <!-- TODO: Make this button open a menu which has buttons for selecting packages -->
      <!-- The buttons in the menu should use the changePackage function -->
      <button class="views-button" onclick="changePackage()">
        Change Package
      </button>
    </div>

   
  </body>
  <script>
    // Hotspots for the scenes
    // TODO: Add hotspots to completely traverse the tour. 
    const sceneHotspots = {
      // Hotspots for "den"
      den: {
        entrance: {
          // Position of the hotspot around the room
          position: "0 -0.2 -4",
          rotation: "0 0 0",
          scale: "0.1 0.1 0.1",
          // Change the parameter to the file of the scene you want to go to
          onclick: "changeScene(`entrance.jpg`)",
        },
      },
      // Hotspots for "entrance"
      entrance: {
        den: {
          position: "0 -0.2 4",
          rotation: "0 0 0",
          scale: "0.1 0.1 0.1",
          onclick: "changeScene(`den.jpg`)",
        },
      },
    };

    const scene = document.querySelector("a-scene");
    const camera = document.querySelector("#camera");
    const model = document.querySelector("#model");

    let selectedPackageIndex = 1;
    let selectedScene = "den";

    // Check if there are device orientation controls
    // Check if the device is a phone
    if (window.DeviceOrientationEvent && window.innerWidth < 768) {
      console.log("Device orientation supported");
      scene.setAttribute("embedded", "true");
    } else {
      console.log("Device orientation not supported");
      scene.setAttribute("embedded", "false");
    }
    

    // if (window.DeviceOrientationEvent) {
    //   console.log("Device orientation supported");
    //   scene.setAttribute("embedded", "true");
    // } else {
    //   console.log("Device orientation not supported");
    //   scene.setAttribute("embedded", "false");
    // }

    model.addEventListener("object3dset", () => {
      console.log("Model loaded");
      changeScene("den.jpg");
    });

    function changeScene(fileName) {
      let modelMesh = model.getObject3D("mesh");

      modelMesh.traverse(function (node) {
        if (node.isMesh) {
          let newTexture = new THREE.TextureLoader().load(
            `./tiles/${selectedPackageIndex}/${fileName}`
          );
          node.material.map = newTexture;
          node.material.side = THREE.DoubleSide;
        }
      });

      console.log("Model: ", modelMesh);

      // Delete all clickables
      let clickables = document.querySelectorAll(".clickable");
      clickables.forEach((clickable) => clickable.parentNode.removeChild(clickable));

      // Add new clickables
      Object.keys(sceneHotspots[selectedScene]).forEach((hotspot) => {
        let hotspotData = sceneHotspots[selectedScene][hotspot];
        let newHotspot = document.createElement("a-entity");
        newHotspot.setAttribute("class", "clickable");
        newHotspot.setAttribute("geometry", "primitive: sphere");
        newHotspot.setAttribute("material", "color: white");
        newHotspot.setAttribute("position", hotspotData.position);
        newHotspot.setAttribute("scale", hotspotData.scale);
        newHotspot.setAttribute("onclick", hotspotData.onclick);
        scene.appendChild(newHotspot);
      });

      // Set the selected scene (without the file extension)
      selectedScene = fileName.split(".")[0];
    }

    // TODO: add a parameter to change the package to the index of the package someone selects from the menu
    function changePackage() {
        selectedPackageIndex = selectedPackageIndex === 1 ? 2 : 1;
        console.log("Selected package: ", selectedPackageIndex);
        changeScene(selectedScene + ".jpg");
      }

    function handleOrientation(event) {
      // For moving the model with the device orientation model rotation 0,0,0 and camera rotation 0,180,0
      // model.setAttribute("rotation", {
      //   x: event.beta,
      //   y: -event.gamma,
      //   z: event.alpha,
      // });

      // For moving the camera with the device orientation model rotation 0,0,0
      camera.setAttribute("rotation", {
        x: -event.beta,
        y: event.gamma,
        z: event.alpha,
      });
    }

    window.addEventListener("deviceorientation", handleOrientation, true);
  </script>
</html>
